

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4. Writing Custom JSON-based Applications &mdash; TU Delft Astrodynamic Toolbox  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="TU Delft Astrodynamic Toolbox  documentation" href="../../index.html"/>
        <link rel="up" title="JSON Interface" href="index.html"/>
        <link rel="next" title="5. Modular Files" href="modularFiles.html"/>
        <link rel="prev" title="3. List of Keys" href="keys/rst/index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> TU Delft Astrodynamic Toolbox
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Start Page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tutorials and Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../basics/index.html">Tudat Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../applicationWalkthroughs/index.html">Application Tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tudatFeatures/index.html">Tudat Libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">JSON Interface</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="basicJsonInterfaces.html">1. Basic JSON Interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorials/index.html">2. Tutorials</a></li>
<li class="toctree-l3"><a class="reference internal" href="keys/rst/index.html">3. List of Keys</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4. Writing Custom JSON-based Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="modularFiles.html">5. Modular Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="multicase.html">6. Multi-case Simulations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../matlabInterface/index.html">MATLAB Interface</a></li>
<li class="toctree-l2"><a class="reference external" href="http://doxygen.tudat.tudelft.nl">Doxygen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../FAQ/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developerGuide/index.html">Developer Guide</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TU Delft Astrodynamic Toolbox</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Tutorials and Documentation</a> &raquo;</li>
        
          <li><a href="index.html">JSON Interface</a> &raquo;</li>
        
      <li>4. Writing Custom JSON-based Applications</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/tutorials/jsonInterface/customJsonApp.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-custom-json-based-applications">
<span id="jsoninterface-customjsonapp"></span><h1>4. Writing Custom JSON-based Applications<a class="headerlink" href="#writing-custom-json-based-applications" title="Permalink to this headline">¶</a></h1>
<p>A simple JSON-based application contains just a few lines of code:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Tudat/JsonInterface/jsonInterface.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">tudat</span><span class="o">::</span><span class="n">json_interface</span><span class="o">::</span><span class="n">JsonSimulationManager</span><span class="o">&lt;</span> <span class="o">&gt;</span> <span class="n">jsonSimulationManager</span><span class="p">(</span> <span class="s">&quot;main.json&quot;</span> <span class="p">);</span>
  <span class="n">jsonSimulationManager</span><span class="p">.</span><span class="n">updateSettings</span><span class="p">(</span> <span class="p">);</span>
  <span class="n">jsonSimulationManager</span><span class="p">.</span><span class="n">runPropagation</span><span class="p">(</span> <span class="p">);</span>
  <span class="n">jsonSimulationManager</span><span class="p">.</span><span class="n">exportResults</span><span class="p">(</span> <span class="p">);</span>
  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>which will always use the file <code class="xref py py-class docutils literal"><span class="pre">main.json</span></code> in the current working directory as input file. If one wants to be able to run the application using different input files, then the code becomes:</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Tudat/JsonInterface/jsonInterface.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[</span> <span class="p">]</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">inputPath</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span> <span class="mi">1</span> <span class="p">];</span>
  <span class="n">tudat</span><span class="o">::</span><span class="n">json_interface</span><span class="o">::</span><span class="n">JsonSimulationManager</span><span class="o">&lt;</span> <span class="o">&gt;</span> <span class="n">jsonSimulationManager</span><span class="p">(</span> <span class="n">inputPath</span> <span class="p">);</span>
  <span class="n">jsonSimulationManager</span><span class="p">.</span><span class="n">updateSettings</span><span class="p">(</span> <span class="p">);</span>
  <span class="n">jsonSimulationManager</span><span class="p">.</span><span class="n">runPropagation</span><span class="p">(</span> <span class="p">);</span>
  <span class="n">jsonSimulationManager</span><span class="p">.</span><span class="n">exportResults</span><span class="p">(</span> <span class="p">);</span>
  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>which is basically the implementation of the <code class="docutils literal"><span class="pre">json_interface</span></code> application in <code class="xref py py-class docutils literal"><span class="pre">Tudat/JsonInterface/jsonInterface.cpp</span></code>.</p>
<p>The four basic steps in a JSON-based applications are:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Create a <code class="xref py py-class docutils literal"><span class="pre">JsonSimulationManager</span></code> object (line 6). This class takes two template arguments, the first being the type to be used for the independent variable (the epoch) and the second the scalar type for the state variable (position, velocity, mass, etc.). When these types are not specified, the default values (<code class="xref py py-class docutils literal"><span class="pre">double</span></code>) are used, i.e. <code class="docutils literal"><span class="pre">JsonSimulationManager&lt;</span> <span class="pre">&gt;</span></code> is equivalent to <code class="docutils literal"><span class="pre">JsonSimulationManager&lt;</span> <span class="pre">double,</span> <span class="pre">double</span> <span class="pre">&gt;</span></code>. The input argument is the absolute or relative path to a JSON file.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When creating a <code class="xref py py-class docutils literal"><span class="pre">JsonSimulationManager</span></code> using this constructor, the current working directory is set to the directory in which the specified file is located.</p>
</div>
<ol class="arabic simple" start="2">
<li>Set up the simulation (line 7). This uses the information contained in the JSON objects parsed from the specified input file to create all the settings objects necessary for the simulation (integrator, bodies, propagator, etc.).</li>
<li>Run the propagation (line 8). In addition to integrating the equations of motion, calling the method <code class="docutils literal"><span class="pre">run</span></code> this will also check whether there are unused keys, print messages and/or generate a file with all the settings that are going be used depending on the settings specified in the key <span class="jsonkey">options</span> of the JSON object.</li>
<li>Export the results (line 9). Calling the method <code class="docutils literal"><span class="pre">exportResults</span></code> will generate the output files with the requested results specified in the key <span class="jsonkey">export</span> of the JSON object.</li>
</ol>
</div></blockquote>
<p>Since not all Tudat features are supported by the JSON interface, in some cases it will be necessary to perform some additional steps between step 2 and 3, i.e. the simulation will be first set up from a JSON file, then additional settings will be provided manually, and the the simulation will be run. Then, optionally, the results can be exported using the <code class="docutils literal"><span class="pre">exportResults</span></code> method. However, defining the additional settings between lines 7 and 8 does not always lead to the desired results, since step 2 is a complex process in which some variables depend on each another.</p>
<p>Imagine that the aerodynamic coefficients of the body to propagate are not specified in the JSON file because they will be provided manually in the C++ file. This may result in an error, since trying to set up a simulation in which one wants to save e.g. the aerodynamic drag on a body with no aerodynamic coefficients interface will result in an error, which is generated while setting up the simulation and not when actually running it. Using a placeholder aerodynamic coefficients interface in the JSON file (e.g. zero force coefficients), this will result in a successful simulation set up, but then, when one wants to reset the aerodynamic coefficients interface in the C++ application manually, it is necessary to reset also all objects that had been set up based on the placeholder coefficients (e.g. the vehicle’s flight conditions). This can be complex and is prone to leading to errors (sometimes run-time errors, sometimes successful simulations in which the results are wrong), so a different approach is followed when writing custom C++ applications.</p>
<p>When setting up the simulation (step 2), the following virtual method is called:</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">virtual</span> <span class="kt">void</span> <span class="nf">updateSettings</span><span class="p">(</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="n">resetIntegratorSettings</span><span class="p">(</span> <span class="p">);</span>
    <span class="n">resetSpice</span><span class="p">(</span> <span class="p">);</span>
    <span class="n">resetBodies</span><span class="p">(</span> <span class="p">);</span>              <span class="c1">// must be called after resetIntegratorSettings and resetSpice</span>
    <span class="n">resetExportSettings</span><span class="p">(</span> <span class="p">);</span>
    <span class="n">resetPropagatorSettings</span><span class="p">(</span> <span class="p">);</span>  <span class="c1">// must be called after resetBodies and resetExportSettings</span>
    <span class="n">resetApplicationOptions</span><span class="p">(</span> <span class="p">);</span>
    <span class="n">resetDynamicsSimulator</span><span class="p">(</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Note that each of the methods called by this method is also virtual. This means that a derived class of <code class="xref py py-class docutils literal"><span class="pre">JsonSimulationManager</span></code> can be created if a custom implementation of any of these methods is needed. The method <code class="docutils literal"><span class="pre">updateSettingsFromJSONObject</span></code> is generally not overridden, as it is dangerous to modify the order in which each of the virtual methods is called. If one <em>does</em> want to modify this method, the following has to be taken into account:</p>
<blockquote>
<div><ul class="simple">
<li>The default implementation of <code class="docutils literal"><span class="pre">resetBodies</span></code> uses the integrator settings’ initial time to interpolate the ephemeris of celestial bodies if Spice is enabled and the key <span class="jsonkey">spice.preloadEpehemeris</span> is set to <code class="docutils literal"><span class="pre">true</span></code>.</li>
<li>The default implementation of <code class="docutils literal"><span class="pre">resetPropagatorSettings</span></code> uses the integrator settings’ initial time to infer the initial state of the celestial bodies from their ephemeris, as well as some of the properties of other bodies (such as initial translational state or mass). Additionally, the variable to be computed are determined from the export settings.</li>
</ul>
</div></blockquote>
<p>In practice, this means that <code class="docutils literal"><span class="pre">resetBodies</span></code> must be called after <code class="docutils literal"><span class="pre">resetIntegratorSettings</span></code> and <code class="docutils literal"><span class="pre">resetSpice</span></code>, and <code class="docutils literal"><span class="pre">resetPropagatorSettings</span></code> must be called after <code class="docutils literal"><span class="pre">resetBodies</span></code> and <code class="docutils literal"><span class="pre">resetExportSettings</span></code>.</p>
<p>Thus, to avoid undefined behaviour, rather than overriding the <code class="docutils literal"><span class="pre">updateSettings</span></code> method, one would override just some of the virtual methods called therein. It is recommended to call the original implementation inside the custom implementations of these methods, and then provide additional steps. For instance, before the <code class="docutils literal"><span class="pre">main</span></code> function:</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CustomJsonSimulationManager</span> <span class="o">:</span> <span class="k">public</span> <span class="n">tudat</span><span class="o">::</span><span class="n">json_interface</span><span class="o">::</span><span class="n">JsonSimulationManager</span><span class="o">&lt;</span> <span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="c1">// Inherit constructor.</span>
    <span class="k">using</span> <span class="n">JsonSimulationManager</span><span class="o">&lt;</span> <span class="o">&gt;::</span><span class="n">JsonSimulationManager</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>
    <span class="c1">// Override resetBodies method.</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">resetBodies</span><span class="p">(</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// First, call the original resetBodies, which uses the information in the JSON file.</span>
        <span class="n">JsonSimulationManager</span><span class="o">::</span><span class="n">resetBodies</span><span class="p">(</span> <span class="p">);</span>

        <span class="c1">// Then, provide additional steps.</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</td></tr></table></div>
<p>Then, in the <code class="docutils literal"><span class="pre">main</span></code> function, we only need to change line 6 to:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="n">CustomJsonSimulationManager</span> <span class="nf">jsonSimulationManager</span><span class="p">(</span> <span class="n">inputPath</span> <span class="p">);</span>
</pre></div>
</div>
<p>If one wants to perform some operations on the results of the integration before exporting them, or does not want to export them to an output file, the call to the <code class="docutils literal"><span class="pre">exportResults</span></code> methods can be omitted, and the results can be retrieved from:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span> <span class="kt">double</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span> <span class="o">&gt;</span> <span class="n">stateHistory</span> <span class="o">=</span>
    <span class="n">jsonSimulationManager</span><span class="p">.</span><span class="n">getDynamicsSimulator</span><span class="p">(</span> <span class="p">)</span><span class="o">-&gt;</span><span class="n">getEquationsOfMotionNumericalSolution</span><span class="p">(</span> <span class="p">);</span>

<span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span> <span class="kt">double</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span> <span class="o">&gt;</span> <span class="n">dependentVariablesHistory</span> <span class="o">=</span>
    <span class="n">jsonSimulationManager</span><span class="p">.</span><span class="n">getDynamicsSimulator</span><span class="p">(</span> <span class="p">)</span><span class="o">-&gt;</span><span class="n">getDependentVariableHistory</span><span class="p">(</span> <span class="p">);</span>
</pre></div>
</div>
<p>A tutorial on how to write a custom JSON-based application can be found in <a class="reference internal" href="tutorials/apolloCapsuleEntry/index.html#jsoninterface-tutorials-apollocapsuleentry"><span class="std std-ref">Apollo Capsule Entry</span></a>.</p>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="modularFiles.html" class="btn btn-neutral float-right" title="5. Modular Files" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="keys/rst/index.html" class="btn btn-neutral" title="3. List of Keys" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Delft University of Technology.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header .arrow").click(function() {
            $(this).closest('.toggle').children().not(".header").toggle(400);
            $(this).toggleClass("open");
            // $(this).html() == "More" ? $(this).html('Less') : $(this).html('More');
        });
        $(".showall").click(function() {
            $(".toggle > *").show(400);
            $(".toggle .header .arrow").addClass("open");
        });
        $(".hideall").click(function() {
            $(".toggle > *").hide(400);
            $(".toggle .header").show(400);
            $(".toggle .header .arrow").removeClass("open");
        });
    });
</script>


</body>
</html>